
＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃
＃                                        ＃
＃   要町 as MSX-View                     ＃
＃     For MSX2/2+/turboR & MSX-DOS(2)    ＃
＃                                        ＃
＃                     By  Ａ ｔｏ Ｃ     ＃
＃                                        ＃
＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃



１．概要

  「MSX-View」付属ROM互換の漢字フォントです。



２．必要とする環境

  ASCII型・8KBバンクのMEGA ROM Controllerで作られた容量240KB以上の似非RAMが必要
です。



３．使用方法

KANAME.ROMをASCII型・8KBバンクのMEGA ROM Controllerで作られた容量240KB以上の似
非RAMにインストールすると、「MSX-View」付属ROM互換の漢字ROMとして動作します。



４．技術資料

アプリケーションから「要町 as MSX-View」を使用する際の技術資料です。

(1) 「要町 as MSX-View」の構成

接続されるスロットは不定です。
MEGA ROM Controller(ASCII型・8KBバンク)により次の様にマッピングされます。
    0000H〜 1FFFH	0000H〜0001Hに'AB'・0010H〜001EHに'MSXViewKROM&2nd'
    2000H〜 26BFH	12x12半角の20H〜7FH
    26C0H〜 5CBFH	12x12全角の区1〜8
    5CC0H〜 613FH	12x12半角のA0H〜DFH
    6140H〜 67FFH	空白(Zero Fillされている)
    6800H〜13FFFH	12x12全角の区16〜47
   14000H〜239BFH	12x12全角の区48〜84
   239C0H〜23FFFH	空白(Zero Fillされている)
   24000H〜2447FH	12x8半角の20H〜7FH
   24480H〜2687FH	12x8全角の区1〜8
   26880H〜26B7FH	12x8半角のA0H〜DFH
   26B80H〜26FFFH	空白(Zero Fillされている)
   27000H〜2FFFFH	12x8全角の区16〜47
   30000H〜3A67FH	12x8全角の区48〜84
   3A680H〜3BFFFH	空白(Zero Fillされている)

MEGA ROM Controllerのバンクアドレスを示します。
	切り替わるアドレス	バンクレジスタのアドレス
	4000H〜5FFFH		6000H〜67FFH
	6000H〜7FFFH		6800H〜6FFFH
	8000H〜9FFFH		7000H〜77FFH
	A000H〜BFFFH		7800H〜7FFFH


(2) 「要町 as MSX-View」の検索

「要町 as MSX-View」は、ASCII型のMEGA ROM Controllerを使って8Kbytesバンクでマッ
ピングされています。Bank=00Hの0010H〜001A以降には'MSXViewKROM&2nd'という文字列
が書き込まれており、MSX-View完全互換で使う時は最初の11bytesを、上位互換として使
う時は15bytes全てを識別子として使用します。
検索時にはバンクレジスタに｢0｣を書き込む必要がありますが、似非RAMdiskやMEGA-SCSI
が存在していると困ったことになります。よって、DRVTBL(FB21H,8)を参照してDISK ROM
のあるスロットは検索対象から外して下さい。


(3) フォントの種類

(i) 12x8

半角・全角とも、１文字に12bytes使って表現されています。
2linesで3bytes使用されており、0〜2bytes目をそれぞれA･B･Cとすれば
		+00 +01 +02 +03 +04 +05 +06 +07 +08 +09 +10 +11
  0th line	 A7  A6  A5  A4  A3  A2  A1  A0  B7  B6  B5  B4
  1st line	 B3  B2  B1  B0  C7  C6  C5  C4  C3  C2  C1  C0
と表現され、これが４回(8lines/12bytes)繰り返されます。
半角の場合、+6〜+11は必ず｢0｣になります。

(ii) 12x12

半角・全角とも、１文字に18bytes使って表現されています。
2linesで3bytes使用されており、0〜2bytes目をそれぞれA･B･Cとすれば
		+00 +01 +02 +03 +04 +05 +06 +07 +08 +09 +10 +11
  0th line	 A7  A6  A5  A4  A3  A2  A1  A0  B7  B6  B5  B4
  1st line	 B3  B2  B1  B0  C7  C6  C5  C4  C3  C2  C1  C0
と表現され、これが６回(12lines/18bytes)繰り返されます。
半角の場合、+6〜+11は必ず｢0｣になります。


(4) フォントへのポインタ取得

(i) 12x8

［半角］
まず、ASCIIコードから20Hを引きます。このとき、繰り下がりが起こるようならば、そ
れはコントロールコードなので、別処理を行います。
次に60H(=80H-20H)と比較し、これより小さければオフセットを24000Hとして処理Ａに飛
びます。
60H以上だった場合、80Hを引き繰り下がりが起こるようならば「要町 as MSX-View」に
は相当するフォントが存在しないので別処理を行います(半角かな)。
繰り下がりが起きなければ、更に40H(=E0H-20H-80H)と比較し、これより小さければオフ
セットを26880Hとして処理Ａに飛びます。40H以上であれば、「要町 as MSX-View」には
相当するフォントが存在しないので別処理を行います(半角かな)。
処理Ａでは、ここまでに求めたコードを12倍し、更に先程のオフセットを加えると、フ
ォントへのポインタを得ます。

［全角］
まず、区点コードを求めます。この時、MSX-View完全互換として使用するならば、第二
水準(区が48以上)の文字は「要町 as MSX-View」を使わずに処理するようコーディング
しなければなりません。上位互換の場合は第二水準も使います。
区点コードを求めたら、区の値からフォントを得る為のオフセットを求めます。
	区		 1〜47		 48〜84
	オフセット	 24000H		 30000H
次に区点コードから漢字コードを求めてこれを12倍し、更に先程のオフセットを加える
とフォントへのポインタを得ます。
実際のコーディングでは、適当にバンクと(バンク内)アドレスの演算を分離した方が効
率が上がると思われます。

(ii) 12x12

［半角］
まず、ASCIIコードから20Hを引きます。このとき、繰り下がりが起こるようならば、そ
れはコントロールコードなので、別処理を行います。
次に60H(=80H-20H)と比較し、これより小さければオフセットを2000Hとして処理Ａに飛
びます。
60H以上だった場合、80Hを引き繰り下がりが起こるようならば「要町 as MSX-View」に
は相当するフォントが存在しないので別処理を行います(半角かな)。
繰り下がりが起きなければ、更に40H(=E0H-20H-80H)と比較し、これより小さければオフ
セットを5CC0Hとして処理Ａに飛びます。40H以上であれば、「要町 as MSX-View」には
相当するフォントが存在しないので別処理を行います(半角かな)。
処理Ａでは、ここまでに求めたコードを18倍し、更に先程のオフセットを加えると、フ
ォントへのポインタを得ます。

［全角］
まず、区点コードを求めます。
区点コードを求めたら、区の値からフォントを得る為のオフセットを求めます。
	区		 1〜47		 48〜84
	オフセット	 2000H		 14000H
次に区点コードから漢字コードを求めてこれを18倍し、更に先程のオフセットを加える
と、フォントへのポインタを得ます。
実際のコーディングでは、適当にバンクと(バンク内)アドレスの演算を分離した方が効
率が上がると思われます。


(5) フォントの取得

まず、スロットを切り替えて「要町 as MSX-View」のインストールされた似非RAMを表に
出します。
次に、ポインタのbit17〜bit13を「要町 as MSX-View」の出ているページに応じたバンクレジスタに書き込んで、バンクを切り替えます。
更にbit12〜bit0にView fontが出ているページの先頭アドレスを足すと、フォントの先
頭アドレスが出ます。このアドレス以降の12bytesもしくは18bytesが求めるフォントで
す。フォントがバンク境界に掛かる事もありますが、ページの前半と後半を連続する二
つのバンクに切り替える様にすると問題無くコーディング出来ます。
フォントの型式は「(3) フォントの種類」を参照して下さい。



５．参考

MSX-Datapack vol.1〜2                       （ASCII）
ＭＳＸテクニカルガイドブック 第四版４刷     （ASCAT）
ＭＳＸテクニカルガイドブック ディスク編
                                第二版二刷  （ASCAT）
機械語の手帳                                （ｒｏｏｔにゃんｐｌｕｓ）
MSX-Viewフォントに関する解説書              （なむ）
メガＲＯＭコントローラー解析資料(第２版)    （つじかわ）



６．開発後記

  SX-WINDOW用に開発された12x12のフリーフォント「要町」をMSX-View付属ROM互換型式
にコンバートしてみました。似非RAMにインストールして使います。
  ソフト的な扱いは、ViewROMと全く同じです。ただ、本家には無い「12x8第二水準」を
搭載している為、識別子とBANK=18H以降に追加がなされています。

  って言ってもねぇ、12x12を無理やり圧縮しているから12x8の文字は第一・第二とも読
めたモンじゃないんだけど (^^;



７．バージョンアップ履歴

  1997/04/29    banさんにネタを貰う    

       05/17    完成



８．著作権・免責

 	１２ドットオリジナルフォント「要町（かなめちょう）」
	Kaname.f12		Version 1.00		1991.11.01
	Copyright (C) 海老原勇士（満開製作所／ﾌｫﾝﾄﾌﾟﾛｼﾞｪｸﾄﾁｰﾑ）, 1991.


質問・感想・苦情等は次のアドレスへ

Internet                  40sp1232@bosei.cc.u-tokai.ac.jp
ｒａｙ−ｎｅｔ            RAY071
Natsume-Net               NAT28124
